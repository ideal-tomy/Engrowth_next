# Next.js ハイドレーションエラーの調査と対策 (`HeroSection` Swiper実装)

## 1. 現象

トップページのヒーローセクションに `swiper/react` を用いたスライドショーを実装したところ、開発サーバーのコンソールに以下のハイドレーションエラーが継続して表示される。

- `Warning: In HTML, whitespace text nodes cannot be a child of <html>...` (初期に表示されたが、`layout.tsx` の修正で解消した可能性あり)
- `Uncaught Error: Hydration failed because the initial UI does not match what was rendered on the server.` (主要なエラーメッセージ)

このエラーは、クライアントサイドでのインタラクション（例: Swiperのナビゲーション操作）に影響を与える可能性がある。

## 2. ハイドレーションエラーとは

Next.js (およびReact) におけるハイドレーションエラーは、サーバーサイドで事前にレンダリングされたHTMLの構造と、クライアントサイドでJavaScript (React) が再構築しようとするコンポーネントツリーの構造が一致しない場合に発生する。

この不一致が起こると、Reactは既存のDOM構造を再利用して効率的にイベントリスナーなどをアタッチする「ハイドレーション」処理に失敗する。結果として、ReactはクライアントサイドでDOM全体を再レンダリングしようとすることがあり、これがパフォーマンスの低下や、最悪の場合イベントハンドラが正しく動作しないなどの問題を引き起こす。

## 3. これまで試した対策と結果

以下に、今回のハイドレーションエラーに対して試みた主な対策とその結果をまとめる。

### 3.1. Swiperコンポーネントのクライアントサイドレンダリング (`useState` + `useEffect`)

- **対策内容:** `HeroSection.tsx` 内で `useState (isMounted)` と `useEffect` を使用し、Swiperコンポーネントがブラウザのクライアント環境でマウントされた後にのみレンダリングされるように試みた。
- **結果:** 当初発生していた別の種類のハイドレーション関連エラー（SwiperのDOM生成タイミングに起因するものと推測）はこれで解消されたものの、根本的な「initial UI does not match what was rendered on the server」エラーは残存した。

### 3.2. `next/image` の使用とSwiperオプションの最小化

- **対策内容:** Swiperコンポーネント内でスライド画像を表示する際、通常の `<img>` タグからNext.js標準の `<Image>` コンポーネント (`fill` プロパティと `style={{objectFit:'cover'}}` を使用) に変更。また、Swiperの `Navigation` や `Pagination` などのオプションモジュールを一時的に無効化した。
- **結果:** ハイドレーションエラーは変わらず。`<Image>` コンポーネントへの変更は画像の最適化や他のパフォーマンス面では有効だが、今回のエラーの直接的な原因ではなかったと判断できる。Swiperのオプションを最小限にしてもエラーは残った。

### 3.3. Swiperコンポーネントの動的インポート (`next/dynamic`)

- **対策内容:**
    1.  Swiperコンポーネントのロジック（モジュールインポート、CSSインポート、Swiper本体のレンダリング）を `DynamicHeroSwiper.tsx` という別コンポーネントに分離。
    2.  メインの `HeroSection.tsx` から `next/dynamic` を使用し、`DynamicHeroSwiper` コンポーネントを `ssr: false` オプション付きで動的にインポート。これにより、Swiperコンポーネントはサーバーサイドレンダリングの対象から除外され、クライアントサイドでのみ読み込まれるようになる。
- **結果:** ハイドレーションエラーは依然として解消されず。この結果から、Swiperコンポーネント自体をSSRから完全に除外しても、ページ全体のどこか別の箇所でサーバーとクライアントのレンダリング結果に不一致が発生している可能性が強く示唆された。

### 3.4. ルートレイアウト (`src/app/layout.tsx`) の確認と修正

- **対策内容:** プロジェクトのルートレイアウトファイルである `src/app/layout.tsx` を確認。特に `<html>` や `<body>` タグの周辺、および `{children}` の前後に不要な空白文字や改行がないか調査。具体的には `<main>{children}</main>` タグ間の改行を削除した。
- **結果:** この修正後も主要なハイドレーションエラーは残存。ただし、初期に表示されていた「whitespace text nodes cannot be a child of <html>」という警告はこの修正で解消された可能性がある（要再確認）。

### 3.5. `HeroSection` へのprops (`title`, `subtitle`) の確認

- **対策内容:** `HeroSection` コンポーネントに渡されている `title` と `subtitle` の値が、呼び出し元である `src/app/page.tsx` でどのように定義・設定されているかを確認。
- **結果:** これらのpropsは静的な文字列リテラルとして渡されており、サーバーサイドとクライアントサイドで値が変動するものではないため、ハイドレーションエラーの直接原因とは考えにくいと判断した。

### 3.6. `reactStrictMode` の無効化

- **対策内容:** `next.config.mjs` ファイルで `reactStrictMode: false` を設定し、Next.jsの開発サーバーを再起動。これにより、開発モードでのReactコンポーネントの二重レンダリングが無効になる。
- **結果:** ハイドレーションエラーは解消されず。このことから、ReactのStrict Modeによる二重レンダリングがエラー検出に影響を与えている（誤検知させている）わけではないと判断できる。

## 4. 現在の状況と今後の調査方針

上記の一連の対策を講じても、依然として「Hydration failed because the initial UI does not match what was rendered on the server.」というエラーが解消されていない。
このエラーは、サーバーがクライアントに送信した初期HTMLと、ブラウザ上でReactが最初にレンダリング（またはハイドレート）しようとしたコンポーネントの構造がどこかで異なっていることを示している。

現時点で考えられるエラー原因の候補：

1.  **Swiperコンポーネント (`DynamicHeroSwiper`) の影響の残存:**
    *   `ssr: false` で動的インポートしても、クライアントサイドでの初期化プロセスがページの他の部分のハイドレーションと微妙に干渉している可能性（非常に低いがゼロではない）。
    *   Swiperがクライアントで付与するクラス名や属性が、予期せぬ差異を生んでいる可能性。
2.  **`HeroSection` コンポーネント内の他の要素:**
    *   画像スライダー以外の部分（例: タイトルやサブタイトルを表示するオーバーレイの `div` 要素など）の構造や属性に、サーバーとクライアントで差異がある可能性。
3.  **`src/app/page.tsx` で使用されている他のカスタムコンポーネント:**
    *   `HeroSection` 以外に `page.tsx` で使用されている `StylishTitle` や `CardComponent` といったコンポーネントが、内部的にサーバーサイドとクライアントサイドで異なるレンダリング結果を生み出している可能性。例えば、これらのコンポーネントが `window` オブジェクトのようなクライアントサイド専用APIを不適切に使用している場合など。
4.  **CSSやフォントの読み込みタイミングによる微細なレイアウト差異:**
    *   非常に稀なケースだが、CSSの適用順序やカスタムフォントの読み込み遅延によって、サーバーレンダリング時とクライアントレンダリング時で要素の計算サイズがわずかに異なり、それがハイドレーションエラーとして検知されることがある。

今後の調査方針案：

1.  **問題箇所の特定（絞り込み戦略）:**
    *   **最優先:** `src/app/page.tsx` で、問題の切り分けとして `<HeroSection />` コンポーネントの呼び出し自体を一時的に完全にコメントアウトする。これでエラーが消えれば、原因は `HeroSection` またはその内部 (`DynamicHeroSwiper`) にあると強く推定できる。エラーが残る場合は、原因は `HeroSection` 以外の部分にある可能性が高い。
    *   上記でエラーが消えない場合、`src/app/page.tsx` で使用されている他のカスタムコンポーネント (`StylishTitle`, `CardComponent` など) を一つずつコメントアウトしていくか、`next/dynamic` を使って `ssr: false` で動的インポートし、エラーがどのコンポーネントに関連しているかを特定する。
2.  **`DynamicHeroSwiper` の更なる単純化（もし `HeroSection` が原因と特定された場合）:**
    *   `Autoplay` モジュールも削除し、スライドの画像も1枚だけの静的なものにするなど、コンポーネントを極限までシンプルにして、エラーが再現するかどうかを確認する。
3.  **Next.jsドキュメントおよび関連GitHub Issuesの再調査:**
    *   使用しているNext.js、React、Swiperの各バージョンを明記の上、これらの組み合わせで同様のハイドレーションエラーが報告されていないか、GitHub Issuesなどを再度詳細に調査する。

エラーメッセージに表示されるスタックトレースも重要な手がかりとなるため、エラー発生時の具体的なコンポーネント階層を追うことも有効である。 